<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Controlgroup - jQuery Mobile Demos</title>
	    <link rel="stylesheet" href="css/themes/default/jquery.mobile-1.4.5.min.css">
	    <link rel="shortcut icon" href="favicon.ico">
	    <script src="js/jquery.min.js"></script>
	    <script src="js/jquery.mobile-1.4.5.min.js"></script>
	    <style>
			.center-wrapper{
				position:absolute;
			  text-align: center;
			}
			.center-wrapper * {
			  margin: 0 auto;
			  padding:0.75em;
			}
			.center-wrapper-inline * {
			  margin: 0 2em;
			}
			
			#right-wrapper{
				right:10em;
				bottom:5em;
			}
			#left-wrapper{
				left:10em;
				bottom:10em;
			}
				
			#leftUpDown {
				position:relative;
				width: 50px;
				height: 200px;
				bottom:-7.5em;
				padding:0;
				background: red;
			}
			#leftLeftRight {
				width: 200px;
				height: 50px;
				padding:0;
				background: blue;
			}
			
			#rightStick {
				width: 200px;
				height: 200px;
				padding:0;
				-webkit-border-radius: 150px;
				-moz-border-radius: 150px;
				border-radius: 150px;
				background: red;
			}
			
			
			
			#mainBackground{
				max-width:100%;
				min-height:100%;
				max-height:100%;
				
				position:absolute;
				
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
			}
			
	    </style>
		
		<script>
			var mouseIsDown = false;
			var nInterval;
			var socketController = new WebSocket("ws://localhost:9001");
			var socketStreamer = new WebSocket("ws://localhost:9002");
			var controlName;
			
			var mouseLocation;
		
			$(function(){

				streamImage();
				document.oncontextmenu = function() {return false;};

				$(document).mousedown(function(e){

					if ( e.button == 2 )
					{ 
						//alert('Right mouse button!'); 
						return false; 
					}

					return true;
				});
				
				$( '.controller' ).mousedown(function(e){
				
					mouseLocation = e;
					controlName = $(this).attr('id');
					
					controllerUsed();
					nInterval = setInterval(function(){
						controllerUsed();
					},50);
					
					return false;
				});
				$( '.controller' ).mousemove(function(e){
					mouseLocation = e;
				});
				$( '.controller' ).mouseup(function(){
					controllerReleased();
					
					return false;
				});
				$( '.controller' ).mouseout(function(){
					controllerReleased();
					
					return false;
				});
				
				socketStreamer.onmessage = function(evt) {
					console.log("Client: Image name -> " + evt.data);
					streamImage(evt.data);
				};
				
			});
			
			function controllerUsed(){
				var offset = $('#rightStick').offset();
				var width = $('#rightStick').width();
				var height = $('#rightStick').height();
				var x = mouseLocation.pageX - (offset.left+(width/2));
				var y = mouseLocation.pageY - (offset.top+(height/2));
				
				//console.log("Click: " + x/100 + " " + y/100);
				
				var result = controlName+","+x/100+","+y/100;
				socketController.send(result);
			}
			function controllerReleased(){
				clearInterval(nInterval);
				socketController.send([0,0]);
			}
			
			
			function streamImage(data){
			
				var image = new Image();
				image.onload = function () {
					console.info("Client: Image loaded");
					var imageParent = document.getElementById("mainBackground");
					imageParent.src = image.src;
					socketStreamer.send("Send image");
				}
				image.onerror = function () {
				   console.error("Client: Cannot load image");
				}
				
				image.src = "stream/" + data + ".jpg";
			}
			
		</script>
	</head>
	<body>
	<div data-role="page" class="jqm-demos" data-quicklinks="true">
		<img id="mainBackground"></img>
	    <div role="main" class="ui-content jqm-content">

				<div class="center-wrapper" id="right-wrapper">
				  <div class="controller" id="rightStick"></div>
				</div>
				
				<div class="center-wrapper" id="left-wrapper">
				  <div class="controller" id="leftUpDown"></div>
				  <div class="controller" id="leftLeftRight"></div>
				</div>
			
		</div>
	</div><!-- /panel -->

</body>
</html>
